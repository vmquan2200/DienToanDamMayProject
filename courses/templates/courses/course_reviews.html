{% extends 'courses/base.html' %}

{% block content %}
<!-- Breadcrumb Section -->
<div class="breadcrumb-optimized" id="breadcrumb">
    <div class="container">
        <div class="cart-breadcrumb">
            <a href="/" class="crumb">
                <span>üè†</span>
                <span>Trang ch·ªß</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            <a href="{% url 'course_list' %}" class="crumb">
                <span>üìö</span>
                <span>Kh√≥a h·ªçc</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            <a href="{% url 'course_detail' course.id %}" class="crumb">
                <span>üìñ</span>
                <span>{{ course.title|truncatechars:20 }}</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            <div class="crumb current">
                <span>‚≠ê</span>
                <span>ƒê√°nh gi√°</span>
            </div>
        </div>
    </div>
</div>

<!-- Review Container -->
<div class="review-page">
    <div class="container">
        <div class="review-wrapper">
            <!-- Review Header -->
            <div class="review-header">
                <h1>‚≠ê ƒê√°nh gi√° kh√≥a h·ªçc</h1>
                <div class="course-info">
                    <div class="course-thumbnail">
                        <div class="thumbnail-placeholder">
                            {{ course.title|slice:":1"|upper }}
                        </div>
                    </div>
                    <div class="course-details">
                        <h2>{{ course.title }}</h2>
                        <div class="course-meta">
                            <span class="meta-item">üë®‚Äçüè´ {{ course.instructor }}</span>
                            <span class="meta-item">üìö {{ course.get_category_display }}</span>
                            {% if course.average_rating %}
                            <span class="meta-item">‚≠ê {{ course.average_rating|floatformat:1 }}/5.0</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Form Card -->
            <div class="review-form-section">
                <div class="form-card">
                    <div class="form-header">
                        <h3>
                            {% if existing_review %}
                                ‚úèÔ∏è Ch·ªânh s·ª≠a ƒë√°nh gi√° c·ªßa b·∫°n
                            {% else %}
                                üìù Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n
                            {% endif %}
                        </h3>
                        <p class="form-subtitle">
                            Chia s·∫ª tr·∫£i nghi·ªám h·ªçc t·∫≠p gi√∫p c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng kh√≥a h·ªçc
                        </p>
                    </div>

                    <form method="post" class="review-form" id="reviewForm">
                        {% csrf_token %}
                        
                        <!-- Rating Section -->
                        <div class="rating-section">
                            <h4>M·ª©c ƒë·ªô h√†i l√≤ng c·ªßa b·∫°n</h4>
                            <div class="stars-container">
                                <div class="stars-input">
                                    {% for i in "12345" %}
                                    <input type="radio" id="star{{ forloop.counter }}" name="rating" 
                                           value="{{ forloop.counter }}" 
                                           {% if existing_review and existing_review.rating == forloop.counter %}checked{% endif %}
                                           required>
                                    <label for="star{{ forloop.counter }}">
                                        <span class="star-icon">‚òÖ</span>
                                        <span class="star-label">{{ forloop.counter }} sao</span>
                                    </label>
                                    {% endfor %}
                                </div>
                                <div class="rating-labels">
                                    <span>R·∫•t kh√¥ng h√†i l√≤ng</span>
                                    <span>R·∫•t h√†i l√≤ng</span>
                                </div>
                            </div>
                        </div>

                        <!-- Comment Section -->
                        <div class="comment-section">
                            <h4>ƒê√°nh gi√° chi ti·∫øt</h4>
                            <div class="textarea-container">
                                <textarea name="comment" rows="8" 
                                          placeholder="Chia s·∫ª tr·∫£i nghi·ªám h·ªçc t·∫≠p c·ªßa b·∫°n...&#10;&#10;‚Ä¢ B·∫°n th√≠ch ƒëi·ªÅu g√¨ nh·∫•t v·ªÅ kh√≥a h·ªçc?&#10;‚Ä¢ ƒêi·ªÉm n√†o c√≥ th·ªÉ c·∫£i thi·ªán?&#10;‚Ä¢ Kh√≥a h·ªçc c√≥ ƒë√°p ·ª©ng mong ƒë·ª£i c·ªßa b·∫°n kh√¥ng?"
                                          maxlength="1000"
                                          id="commentTextarea">{% if existing_review %}{{ existing_review.comment }}{% endif %}</textarea>
                                <div class="textarea-footer">
                                    <small class="char-count">0/1000 k√Ω t·ª±</small>
                                    <small class="form-hint">ƒê√°nh gi√° chi ti·∫øt s·∫Ω gi√∫p h·ªçc vi√™n kh√°c c√≥ c√°i nh√¨n r√µ h∆°n</small>
                                </div>
                            </div>
                        </div>

                        <!-- Review Tips -->
                        <div class="review-tips">
                            <h5>üí° M·∫πo vi·∫øt ƒë√°nh gi√° h·ªØu √≠ch</h5>
                            <ul>
                                <li>Chia s·∫ª tr·∫£i nghi·ªám h·ªçc t·∫≠p th·ª±c t·∫ø c·ªßa b·∫°n</li>
                                <li>N√™u r√µ ƒëi·ªÉm m·∫°nh v√† ƒëi·ªÉm c√≥ th·ªÉ c·∫£i thi·ªán</li>
                                <li>Tr√°nh s·ª≠ d·ª•ng ng√¥n ng·ªØ kh√¥ng ph√π h·ª£p</li>
                                <li>T·∫≠p trung v√†o n·ªôi dung v√† ch·∫•t l∆∞·ª£ng gi·∫£ng d·∫°y</li>
                            </ul>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <a href="{% url 'course_detail' course.id %}" class="btn-cancel">
                                <span>‚Üê</span>
                                <span>Quay l·∫°i</span>
                            </a>
                            <button type="submit" class="btn-submit">
                                {% if existing_review %}
                                <span>üîÑ</span>
                                <span>C·∫≠p nh·∫≠t ƒë√°nh gi√°</span>
                                {% else %}
                                <span>üöÄ</span>
                                <span>G·ª≠i ƒë√°nh gi√°</span>
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Existing Review Preview -->
                {% if existing_review %}
                <div class="existing-review-card">
                    <div class="card-header">
                        <h4>üìã ƒê√°nh gi√° hi·ªán t·∫°i c·ªßa b·∫°n</h4>
                        <span class="review-date">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: {{ existing_review.updated_at|date:"d/m/Y" }}</span>
                    </div>
                    <div class="review-preview">
                        <div class="preview-rating">
                            {% for i in "12345" %}
                            <span class="star {% if i|add:"0" <= existing_review.rating %}filled{% endif %}">‚òÖ</span>
                            {% endfor %}
                        </div>
                        <p class="preview-comment">{{ existing_review.comment|truncatechars:200 }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --accent: #3b82f6;
    --accent-2: #6366f1;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --text: #1e293b;
    --muted: #64748b;
    --light: #f8fafc;
    --border: #e2e8f0;
    --shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    --radius: 16px;
    --transition: all 0.3s ease;
}

/* ===== BREADCRUMB STYLES ===== */
.breadcrumb-optimized {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 1rem 0;
    border-bottom: 1px solid rgba(226, 232, 240, 0.8);
    transition: var(--transition);
}

.breadcrumb-optimized.sticky {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    padding: 0.75rem 0;
    background: rgba(255, 255, 255, 0.98);
}

.breadcrumb-optimized .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.cart-breadcrumb {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
    background: white;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    transition: var(--transition);
}

.breadcrumb-optimized.sticky .cart-breadcrumb {
    padding: 0.5rem 1.25rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.crumb {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: 8px;
    transition: var(--transition);
}

.crumb:hover {
    background: rgba(59, 130, 246, 0.1);
    transform: translateY(-1px);
}

.crumb.current {
    color: var(--text);
    font-weight: 600;
    cursor: default;
    background: #f8fafc;
}

.crumb-separator {
    color: var(--muted);
}

/* Review Page */
.review-page {
    background: var(--light);
    min-height: 100vh;
    padding: 40px 0;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 20px;
}

/* Review Header */
.review-header {
    text-align: center;
    margin-bottom: 40px;
}

.review-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.course-info {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 25px;
    text-align: left;
}

.course-thumbnail {
    flex-shrink: 0;
}

.thumbnail-placeholder {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    font-weight: 700;
}

.course-details {
    flex: 1;
}

.course-details h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 10px;
    line-height: 1.3;
}

.course-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 10px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--muted);
    font-size: 0.95rem;
}

/* Review Form Section */
.review-form-section {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.form-card {
    background: white;
    border-radius: var(--radius);
    padding: 40px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
}

.form-header {
    text-align: center;
    margin-bottom: 40px;
}

.form-header h3 {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.form-subtitle {
    color: var(--muted);
    font-size: 1.1rem;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
}

/* Rating Section */
.rating-section {
    margin-bottom: 40px;
}

.rating-section h4 {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 20px;
    text-align: center;
}

.stars-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.stars-input {
    display: flex;
    flex-direction: row-reverse;
    gap: 5px;
}

.stars-input input {
    display: none;
}

.stars-input label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    padding: 10px;
    border-radius: 10px;
    transition: var(--transition);
}

.stars-input label:hover {
    background: var(--light);
}

.star-icon {
    font-size: 3.5rem;
    color: #e2e8f0;
    transition: var(--transition);
}

.star-label {
    font-size: 0.9rem;
    color: var(--muted);
    font-weight: 500;
    opacity: 0;
    transition: var(--transition);
}

.stars-input label:hover .star-label,
.stars-input input:checked + label .star-label {
    opacity: 1;
}

.stars-input input:checked ~ label .star-icon,
.stars-input label:hover .star-icon,
.stars-input label:hover ~ label .star-icon {
    color: var(--warning);
}

.stars-input input:checked + label .star-icon {
    color: var(--warning);
    animation: bounce 0.5s;
}

@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.rating-labels {
    display: flex;
    justify-content: space-between;
    width: 100%;
    max-width: 500px;
    color: var(--muted);
    font-size: 0.9rem;
    margin-top: 10px;
}

/* Comment Section */
.comment-section {
    margin-bottom: 40px;
}

.comment-section h4 {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 15px;
}

.textarea-container {
    position: relative;
}

.textarea-container textarea {
    width: 100%;
    padding: 20px;
    border: 2px solid var(--border);
    border-radius: 12px;
    font-size: 1rem;
    font-family: inherit;
    line-height: 1.6;
    resize: vertical;
    min-height: 150px;
    transition: var(--transition);
}

.textarea-container textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.textarea-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    flex-wrap: wrap;
    gap: 10px;
}

.char-count {
    color: var(--muted);
    font-size: 0.9rem;
    font-weight: 500;
}

.form-hint {
    color: var(--muted);
    font-size: 0.85rem;
}

/* Review Tips */
.review-tips {
    background: var(--light);
    padding: 25px;
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-bottom: 40px;
}

.review-tips h5 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.review-tips ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.review-tips li {
    margin-bottom: 10px;
    color: var(--muted);
    position: relative;
    padding-left: 25px;
}

.review-tips li:before {
    content: "‚úì";
    position: absolute;
    left: 0;
    color: var(--success);
    font-weight: bold;
}

/* Form Actions */
.form-actions {
    display: flex;
    gap: 20px;
}

.btn-cancel, .btn-submit {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 30px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    border: none;
    font-family: inherit;
    flex: 1;
    justify-content: center;
}

.btn-cancel {
    background: var(--light);
    color: var(--text);
    border: 2px solid var(--border);
}

.btn-cancel:hover {
    background: white;
    border-color: var(--danger);
    color: var(--danger);
    transform: translateX(-5px);
}

.btn-submit {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: white;
}

.btn-submit:hover {
    background: linear-gradient(135deg, var(--accent-2), #4f46e5);
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
}

/* Existing Review Card */
.existing-review-card {
    background: white;
    border-radius: var(--radius);
    padding: 30px;
    box-shadow: var(--shadow);
    border: 2px solid var(--success);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.card-header h4 {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
}

.review-date {
    color: var(--muted);
    font-size: 0.9rem;
}

.review-preview {
    background: var(--light);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border);
}

.preview-rating {
    margin-bottom: 15px;
}

.preview-rating .star {
    font-size: 1.5rem;
    color: #e2e8f0;
    margin-right: 5px;
}

.preview-rating .star.filled {
    color: var(--warning);
}

.preview-comment {
    color: var(--text);
    line-height: 1.6;
    margin: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .review-header h1 {
        font-size: 2rem;
    }
    
    .course-info {
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }
    
    .course-meta {
        justify-content: center;
    }
    
    .form-card {
        padding: 25px;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn-cancel, .btn-submit {
        width: 100%;
    }
    
    .stars-input {
        gap: 2px;
    }
    
    .star-icon {
        font-size: 2.5rem;
    }
    
    /* Responsive breadcrumb */
    .cart-breadcrumb {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .crumb span:last-child {
        display: none;
    }
    
    .crumb {
        padding: 0.5rem;
    }
}

@media (max-width: 480px) {
    .review-page {
        padding: 20px 0;
    }
    
    .container {
        padding: 0 15px;
    }
    
    .form-header h3 {
        font-size: 1.5rem;
    }
    
    .rating-labels {
        flex-direction: column;
        gap: 5px;
        text-align: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character counter
    const commentTextarea = document.getElementById('commentTextarea');
    const charCount = document.querySelector('.char-count');
    
    commentTextarea.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = `${count}/1000 k√Ω t·ª±`;
        
        if (count > 900) {
            charCount.style.color = 'var(--danger)';
        } else if (count > 750) {
            charCount.style.color = 'var(--warning)';
        } else {
            charCount.style.color = 'var(--muted)';
        }
    });
    
    // Initialize character count
    commentTextarea.dispatchEvent(new Event('input'));
    
    // Star hover effect
    const starLabels = document.querySelectorAll('.stars-input label');
    const starIcons = document.querySelectorAll('.star-icon');
    
    starLabels.forEach(label => {
        label.addEventListener('mouseenter', function() {
            const starId = this.getAttribute('for');
            const starNumber = parseInt(starId.replace('star', ''));
            
            // Highlight all stars up to this one
            starIcons.forEach((icon, index) => {
                if (index < starNumber) {
                    icon.style.color = 'var(--warning)';
                    icon.style.transform = 'scale(1.1)';
                }
            });
        });
        
        label.addEventListener('mouseleave', function() {
            // Reset stars to checked state
            starIcons.forEach((icon, index) => {
                const input = document.querySelector(`#star${index + 1}`);
                icon.style.color = input.checked ? 'var(--warning)' : '#e2e8f0';
                icon.style.transform = 'scale(1)';
            });
        });
    });
    
    // Form submission validation
    const reviewForm = document.getElementById('reviewForm');
    reviewForm.addEventListener('submit', function(e) {
        const rating = this.querySelector('input[name="rating"]:checked');
        const comment = commentTextarea.value.trim();
        
        if (!rating) {
            e.preventDefault();
            alert('Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!');
            return;
        }
        
        if (!comment) {
            e.preventDefault();
            alert('Vui l√≤ng nh·∫≠p n·ªôi dung ƒë√°nh gi√°!');
            commentTextarea.focus();
            return;
        }
        
        if (comment.length > 1000) {
            e.preventDefault();
            alert('N·ªôi dung ƒë√°nh gi√° kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 1000 k√Ω t·ª±!');
            commentTextarea.focus();
            return;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('.btn-submit');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = `
            <div class="loading-spinner"></div>
            <span>ƒêang x·ª≠ l√Ω...</span>
        `;
        submitBtn.disabled = true;
    });
    
    // Sticky breadcrumb effect
    const breadcrumb = document.getElementById('breadcrumb');
    if (breadcrumb) {
        window.addEventListener('scroll', function() {
            if (window.scrollY > 50) {
                breadcrumb.classList.add('sticky');
            } else {
                breadcrumb.classList.remove('sticky');
            }
        });
    }
});

// Loading spinner style
const style = document.createElement('style');
style.textContent = `
.loading-spinner {
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}