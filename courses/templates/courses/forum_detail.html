{% extends 'courses/base.html' %}

{% block content %}
<!-- Th√™m Breadcrumb -->
<div class="breadcrumb-optimized" id="breadcrumb">
    <div class="container">
        <div class="cart-breadcrumb">
            <a href="/" class="crumb">
                <span>üè†</span>
                <span>Trang ch·ªß</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            <a href="{% url 'forum_list' %}" class="crumb">
                <span>üí¨</span>
                <span>Di·ªÖn ƒë√†n</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            {% if post.category %}
            <a href="{% url 'forum_category' post.category %}" class="crumb">
                <span>üè∑Ô∏è</span>
                <span>{{ post.get_category_display }}</span>
            </a>
            <div class="crumb-separator">‚Ä∫</div>
            {% endif %}
            <div class="crumb current">
                <span>üìñ</span>
                <span>{{ post.title|truncatechars:40 }}</span>
            </div>
        </div>
    </div>
</div>

<div class="forum-detail-page">
    <!-- Navigation -->
    <div class="detail-navigation">
        <div class="container">
            <div class="nav-content">
                <a href="{% url 'forum_list' %}" class="nav-back">
                    <span class="nav-icon">‚Üê</span>
                    <span class="nav-text">Quay l·∫°i di·ªÖn ƒë√†n</span>
                </a>
                
                <div class="nav-actions">
                    {% if user == post.author or user.is_staff %}
                    <div class="dropdown">
                        <button class="dropdown-toggle">
                            <span>‚öôÔ∏è</span>
                            <span>Tu·ª≥ ch·ªçn</span>
                        </button>
                        <div class="dropdown-menu">
                            {% if user.is_staff %}
                            <form method="post" action="{% url 'admin:forum_toggle_pin' post.id %}" class="dropdown-form">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">
                                    {% if post.is_pinned %}üìå B·ªè ghim{% else %}üìå Ghim b√†i{% endif %}
                                </button>
                            </form>
                            {% if post.is_featured %}
                            <form method="post" action="{% url 'admin:forum_toggle_feature' post.id %}" class="dropdown-form">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">
                                    ‚≠ê B·ªè n·ªïi b·∫≠t
                                </button>
                            </form>
                            {% else %}
                            <form method="post" action="{% url 'admin:forum_toggle_feature' post.id %}" class="dropdown-form">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">
                                    ‚≠ê ƒê√°nh d·∫•u n·ªïi b·∫≠t
                                </button>
                            </form>
                            {% endif %}
                            {% endif %}
                            <a href="{% url 'forum_edit' post.id %}" class="dropdown-item">‚úèÔ∏è Ch·ªânh s·ª≠a b√†i vi·∫øt</a>
                            {% if user.is_staff %}
                            <button class="dropdown-item delete-post">üóëÔ∏è Xo√° b√†i vi·∫øt</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <button class="nav-action" onclick="scrollToComments()">
                        <span>üí¨</span>
                        <span>B√¨nh lu·∫≠n</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="detail-wrapper">
            <!-- Left: Main Post -->
            <div class="detail-main">
                <!-- Post Badges -->
                <div class="post-badges">
                    {% if post.is_pinned %}
                    <span class="badge pinned">üìå B√†i vi·∫øt ƒë∆∞·ª£c ghim</span>
                    {% endif %}
                    {% if post.is_featured %}
                    <span class="badge featured">‚≠ê B√†i vi·∫øt n·ªïi b·∫≠t</span>
                    {% endif %}
                    {% if post.is_solved %}
                    <span class="badge solved">‚úÖ ƒê√£ gi·∫£i ƒë√°p</span>
                    {% endif %}
                    <span class="badge category">{{ post.get_category_display }}</span>
                </div>

                <!-- Main Post -->
                <article class="main-post">
                    <header class="post-header">
                        <div class="author-section">
                            <div class="author-avatar">
                                {{ post.author.username|slice:":1"|upper }}
                            </div>
                            <div class="author-info">
                                <div class="author-main">
                                    <strong class="author-name">{{ post.author.username }}</strong>
                                    {% if post.author.is_staff %}
                                    <span class="author-badge staff">üëë Admin</span>
                                    {% endif %}
                                    {% if post.author.is_expert %}
                                    <span class="author-badge expert">üß† Chuy√™n gia</span>
                                    {% endif %}
                                </div>
                                <div class="post-meta">
                                    <span class="post-time">{{ post.created_at|date:"H:i ‚Ä¢ d/m/Y" }}</span>
                                    {% if post.updated_at != post.created_at %}
                                    <span class="post-edited">(ƒë√£ ch·ªânh s·ª≠a {{ post.updated_at|timesince }} tr∆∞·ªõc)</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="post-stats">
                            <div class="stat-item">
                                <span class="stat-icon">üëÅÔ∏è</span>
                                <span class="stat-value">{{ post.views|default:"1.2k" }}</span>
                                <span class="stat-label">l∆∞·ª£t xem</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üí¨</span>
                                <span class="stat-value">{{ comments|length }}</span>
                                <span class="stat-label">b√¨nh lu·∫≠n</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">‚è±Ô∏è</span>
                                <span class="stat-value">{{ post.reading_time|default:"5" }} ph√∫t</span>
                            </div>
                        </div>
                    </header>

                    <h1 class="post-title">{{ post.title }}</h1>

                    <div class="post-content" id="postContent">
                        {{ post.content|linebreaksbr|urlize }}
                    </div>

                    {% if post.tags %}
                    <div class="post-tags">
                        {% for tag in post.tags.split %}
                        <a href="{% url 'forum_tag' tag %}" class="post-tag">#{{ tag }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <footer class="post-footer">
                        <div class="reaction-section">
                            <form method="post" action="{% url 'toggle_like' post.id %}" class="reaction-form like-form">
                                {% csrf_token %}
                                <button type="button" class="reaction-btn like-btn {% if user_has_liked %}active{% endif %}">
                                    <span class="reaction-icon">‚ù§Ô∏è</span>
                                    <span class="reaction-count">{{ like_count }}</span>
                                    <span class="reaction-label">Th√≠ch</span>
                                </button>
                            </form>
                            
                            <button class="reaction-btn" onclick="toggleReactions()">
                                <span class="reaction-icon">üëç</span>
                                <span class="reaction-count">42</span>
                            </button>
                            
                            <div class="reactions-panel" id="reactionsPanel">
                                <button class="reaction-option" data-reaction="like">üëç</button>
                                <button class="reaction-option" data-reaction="love">‚ù§Ô∏è</button>
                                <button class="reaction-option" data-reaction="laugh">üòÑ</button>
                                <button class="reaction-option" data-reaction="wow">üò≤</button>
                                <button class="reaction-option" data-reaction="sad">üò¢</button>
                                <button class="reaction-option" data-reaction="angry">üò†</button>
                            </div>
                        </div>

                        <div class="action-section">
                            <button class="action-btn" onclick="sharePost()">
                                <span class="action-icon">üì§</span>
                                <span class="action-text">Chia s·∫ª</span>
                            </button>
                            
                            <button class="action-btn bookmark-btn {% if user_has_saved %}active{% endif %}" 
                                    onclick="toggleBookmark()">
                                <span class="action-icon">üîñ</span>
                                <span class="action-text">L∆∞u</span>
                            </button>
                            
                            <button class="action-btn" onclick="scrollToComments()">
                                <span class="action-icon">üí¨</span>
                                <span class="action-text">B√¨nh lu·∫≠n</span>
                            </button>
                            
                            <button class="action-btn report-btn" onclick="reportPost()">
                                <span class="action-icon">üö®</span>
                                <span class="action-text">B√°o c√°o</span>
                            </button>
                        </div>
                    </footer>

                    <!-- Post Navigation -->
                    <div class="post-navigation">
                        {% if previous_post %}
                        <a href="{% url 'forum_detail' previous_post.id %}" class="nav-post prev">
                            <span class="nav-direction">‚Üê B√†i tr∆∞·ªõc</span>
                            <span class="nav-title">{{ previous_post.title|truncatechars:50 }}</span>
                        </a>
                        {% endif %}
                        
                        {% if next_post %}
                        <a href="{% url 'forum_detail' next_post.id %}" class="nav-post next">
                            <span class="nav-direction">B√†i sau ‚Üí</span>
                            <span class="nav-title">{{ next_post.title|truncatechars:50 }}</span>
                        </a>
                        {% endif %}
                    </div>
                </article>

                <!-- Comments Section -->
                <section class="comments-section" id="commentsSection">
                    <div class="section-header">
                        <h2>
                            <span class="section-icon">üí¨</span>
                            <span class="section-title">B√¨nh lu·∫≠n</span>
                            <span class="comment-count">({{ comments|length }})</span>
                        </h2>
                        <div class="section-actions">
                            <button class="sort-btn" onclick="toggleSort()">
                                <span>S·∫Øp x·∫øp: </span>
                                <span id="sortText">M·ªõi nh·∫•t</span>
                                <span>‚ñº</span>
                            </button>
                        </div>
                    </div>

                    <!-- Comment Form -->
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'add_comment' post.id %}" class="comment-form" id="commentForm">
                        {% csrf_token %}
                        <div class="comment-editor">
                            <div class="editor-header">
                                <div class="editor-tools">
                                    <button type="button" class="tool-btn" data-tag="bold"><b>B</b></button>
                                    <button type="button" class="tool-btn" data-tag="italic"><i>I</i></button>
                                    <button type="button" class="tool-btn" data-tag="code">{"{}"}</button>
                                    <button type="button" class="tool-btn" data-tag="link">üîó</button>
                                </div>
                            </div>
                            <textarea name="content" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." 
                                      required rows="3" class="comment-input"></textarea>
                            <div class="editor-footer">
                                <small>Nh·∫•n Ctrl+Enter ƒë·ªÉ g·ª≠i nhanh</small>
                                <button type="submit" class="btn-submit">
                                    <span>üì§</span>
                                    <span>G·ª≠i b√¨nh lu·∫≠n</span>
                                </button>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="auth-prompt">
                        <div class="prompt-icon">üîí</div>
                        <div class="prompt-content">
                            <h3>ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n</h3>
                            <p>Tham gia th·∫£o lu·∫≠n c√πng c·ªông ƒë·ªìng l·∫≠p tr√¨nh vi√™n</p>
                            <div class="prompt-actions">
                                <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn-login">üîì ƒêƒÉng nh·∫≠p</a>
                                <a href="{% url 'account_signup' %}" class="btn-signup">üìù ƒêƒÉng k√Ω</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Comments List -->
                    <div class="comments-list" id="commentsList">
                        {% for comment in comments %}
                        <div class="comment-card {% if comment.author == post.author %}author-comment{% endif %}" 
                             data-comment-id="{{ comment.id }}">
                            <div class="comment-header">
                                <div class="comment-author">
                                    <div class="comment-avatar">
                                        {{ comment.author.username|slice:":1"|upper }}
                                    </div>
                                    <div class="comment-info">
                                        <strong class="comment-name">{{ comment.author.username }}</strong>
                                        {% if comment.author == post.author %}
                                        <span class="comment-badge author">üëë T√°c gi·∫£</span>
                                        {% endif %}
                                        <span class="comment-time">{{ comment.created_at|timesince }} tr∆∞·ªõc</span>
                                    </div>
                                </div>
                                
                                {% if user == comment.author or user.is_staff %}
                                <div class="comment-actions">
                                    <button class="action-btn edit-comment" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
                                    <button class="action-btn delete-comment" title="Xo√°">üóëÔ∏è</button>
                                    {% if user.is_staff %}
                                    <button class="action-btn report-comment" title="B√°o c√°o">üö®</button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="comment-content">
                                {{ comment.content|linebreaksbr }}
                            </div>
                            
                            <div class="comment-footer">
                                <button class="reply-btn" onclick="replyToComment({{ comment.id }}, '{{ comment.author.username }}')">
                                    <span>‚Ü©Ô∏è</span>
                                    <span>Tr·∫£ l·ªùi</span>
                                </button>
                                
                                <button class="like-comment {% if comment.user_has_liked %}active{% endif %}">
                                    <span>üëç</span>
                                    <span>{{ comment.like_count|default:"0" }}</span>
                                </button>
                            </div>
                            
                            <!-- Reply Form (hidden by default) -->
                            <div class="reply-form" style="display: none;" id="replyForm{{ comment.id }}">
                                <textarea placeholder="Tr·∫£ l·ªùi {{ comment.author.username }}..." rows="2"></textarea>
                                <div class="reply-actions">
                                    <button class="btn-cancel" onclick="cancelReply({{ comment.id }})">H·ªßy</button>
                                    <button class="btn-send" onclick="sendReply({{ comment.id }})">G·ª≠i</button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-comments">
                            <div class="no-comments-icon">üí¨</div>
                            <h3>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</h3>
                            <p>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n cho b√†i vi·∫øt n√†y!</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Load More -->
                    {% if comments.has_next %}
                    <div class="load-more">
                        <button class="btn-load-more" onclick="loadMoreComments()">
                            <span>‚¨áÔ∏è</span>
                            <span>T·∫£i th√™m b√¨nh lu·∫≠n</span>
                        </button>
                    </div>
                    {% endif %}
                </section>
            </div>

            <!-- Right: Sidebar -->
            <div class="detail-sidebar">
                <!-- Author Info -->
                <div class="sidebar-section author-widget">
                    <h3 class="section-title">üë§ T√°c gi·∫£</h3>
                    <div class="author-profile">
                        <div class="profile-avatar large">
                            {{ post.author.username|slice:":1"|upper }}
                        </div>
                        <div class="profile-info">
                            <h4 class="profile-name">{{ post.author.username }}</h4>
                            <div class="profile-stats">
                                <div class="profile-stat">
                                    <span class="stat-number">{{ author_posts_count|default:"0" }}</span>
                                    <span class="stat-label">b√†i vi·∫øt</span>
                                </div>
                                <div class="profile-stat">
                                    <span class="stat-number">{{ author_comments_count|default:"0" }}</span>
                                    <span class="stat-label">b√¨nh lu·∫≠n</span>
                                </div>
                            </div>
                            <a href="{% url 'user_profile' post.author.username %}" class="btn-profile">
                                üëÅÔ∏è Xem trang c√° nh√¢n
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Related Posts -->
                <div class="sidebar-section">
                    <h3 class="section-title">üìö B√†i vi·∫øt li√™n quan</h3>
                    <div class="related-posts">
                        {% for related in related_posts %}
                        <a href="{% url 'forum_detail' related.id %}" class="related-post">
                            <h4 class="related-title">{{ related.title|truncatechars:60 }}</h4>
                            <div class="related-meta">
                                <span class="related-comments">üí¨ {{ related.comment_count }}</span>
                                <span class="related-time">{{ related.created_at|timesince }} tr∆∞·ªõc</span>
                            </div>
                        </a>
                        {% empty %}
                        <div class="no-related">
                            <p>Ch∆∞a c√≥ b√†i vi·∫øt li√™n quan</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Popular Tags -->
                <div class="sidebar-section">
                    <h3 class="section-title">üè∑Ô∏è Th·∫ª ph·ªï bi·∫øn</h3>
                    <div class="popular-tags">
                        <a href="{% url 'forum_tag' 'python' %}" class="popular-tag">python</a>
                        <a href="{% url 'forum_tag' 'django' %}" class="popular-tag">django</a>
                        <a href="{% url 'forum_tag' 'javascript' %}" class="popular-tag">javascript</a>
                        <a href="{% url 'forum_tag' 'web-development' %}" class="popular-tag">web-development</a>
                        <a href="{% url 'forum_tag' 'react' %}" class="popular-tag">react</a>
                        <a href="{% url 'forum_tag' 'database' %}" class="popular-tag">database</a>
                    </div>
                </div>

                <!-- Community Stats -->
                <div class="sidebar-section">
                    <h3 class="section-title">üìä Th·ªëng k√™ c·ªông ƒë·ªìng</h3>
                    <div class="community-stats">
                        <div class="community-stat">
                            <span class="stat-icon">üìù</span>
                            <div class="stat-info">
                                <span class="stat-number">{{ total_posts|default:"1.2k" }}</span>
                                <span class="stat-label">b√†i vi·∫øt</span>
                            </div>
                        </div>
                        <div class="community-stat">
                            <span class="stat-icon">üí¨</span>
                            <div class="stat-info">
                                <span class="stat-number">{{ total_comments|default:"5.8k" }}</span>
                                <span class="stat-label">b√¨nh lu·∫≠n</span>
                            </div>
                        </div>
                        <div class="community-stat">
                            <span class="stat-icon">üë•</span>
                            <div class="stat-info">
                                <span class="stat-number">{{ total_users|default:"850" }}</span>
                                <span class="stat-label">th√†nh vi√™n</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <h3 class="section-title">‚ö° H√†nh ƒë·ªông nhanh</h3>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="scrollToComments()">
                            <span class="action-icon">üí¨</span>
                            <span class="action-text">Vi·∫øt b√¨nh lu·∫≠n</span>
                        </button>
                        <button class="quick-action" onclick="sharePost()">
                            <span class="action-icon">üì§</span>
                            <span class="action-text">Chia s·∫ª b√†i vi·∫øt</span>
                        </button>
                        <a href="{% url 'forum_create' %}" class="quick-action">
                            <span class="action-icon">üìù</span>
                            <span class="action-text">Vi·∫øt b√†i m·ªõi</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Delete Confirmation -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <h3>üóëÔ∏è X√°c nh·∫≠n xo√°</h3>
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° b√†i vi·∫øt n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">H·ªßy</button>
            <form method="post" action="{% url 'forum_delete' post.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn-delete">Xo√° b√†i vi·∫øt</button>
            </form>
        </div>
    </div>
</div>

<style>
/* ===== BREADCRUMB STYLES ===== */
.breadcrumb-optimized {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 1rem 0;
    border-bottom: 1px solid rgba(226, 232, 240, 0.8);
    transition: var(--transition);
}

.breadcrumb-optimized.sticky {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    padding: 0.75rem 0;
    background: rgba(255, 255, 255, 0.98);
}

.breadcrumb-optimized .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
}

.cart-breadcrumb {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
    background: white;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    transition: var(--transition);
}

.breadcrumb-optimized.sticky .cart-breadcrumb {
    padding: 0.5rem 1.25rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.crumb {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: 8px;
    transition: var(--transition);
}

.crumb:hover {
    background: rgba(59, 130, 246, 0.1);
    transform: translateY(-1px);
}

.crumb.current {
    color: var(--text);
    font-weight: 600;
    cursor: default;
    background: #f8fafc;
}

.crumb-separator {
    color: var(--muted);
}

/* Rest of your existing CSS stays exactly the same... */
:root {
    --accent: #3b82f6;
    --accent-2: #6366f1;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --text: #1e293b;
    --muted: #64748b;
    --light: #f8fafc;
    --border: #e2e8f0;
    --shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    --radius: 16px;
    --transition: all 0.3s ease;
}

/* Forum Detail Page */
.forum-detail-page {
    background: var(--light);
    min-height: 100vh;
}

/* C√°c ph·∫ßn CSS c√≤n l·∫°i gi·ªØ nguy√™n... */
/* (CSS c·ªßa b·∫°n gi·ªØ nguy√™n t·ª´ ƒë√¢y tr·ªü xu·ªëng) */

/* Responsive cho breadcrumb */
@media (max-width: 768px) {
    .cart-breadcrumb {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .crumb span:last-child {
        display: none;
    }
    
    .crumb {
        padding: 0.5rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Breadcrumb sticky effect
    const breadcrumb = document.getElementById('breadcrumb');
    if (breadcrumb) {
        window.addEventListener('scroll', function() {
            if (window.scrollY > 50) {
                breadcrumb.classList.add('sticky');
            } else {
                breadcrumb.classList.remove('sticky');
            }
        });
        
        // Responsive breadcrumb
        function handleResponsiveBreadcrumb() {
            const crumbs = breadcrumb.querySelectorAll('.crumb span:last-child');
            const isMobile = window.innerWidth <= 768;
            
            crumbs.forEach(crumb => {
                if (isMobile && !crumb.closest('.crumb').classList.contains('current')) {
                    crumb.style.display = 'none';
                } else {
                    crumb.style.display = 'inline';
                }
            });
        }
        
        handleResponsiveBreadcrumb();
        window.addEventListener('resize', handleResponsiveBreadcrumb);
    }

    // C√°c JavaScript kh√°c gi·ªØ nguy√™n...
    // Elements
    const likeForm = document.querySelector('.like-form');
    const likeBtn = document.querySelector('.like-btn');
    const reactionsPanel = document.getElementById('reactionsPanel');
    const commentForm = document.getElementById('commentForm');
    const commentInput = document.querySelector('.comment-input');
    const deleteModal = document.getElementById('deleteModal');
    const toolButtons = document.querySelectorAll('.tool-btn');
    const deletePostBtn = document.querySelector('.delete-post');
    
    // Like functionality
    if (likeBtn) {
        likeBtn.addEventListener('click', function(e) {
            if (likeForm) {
                const formData = new FormData(likeForm);
                
                fetch(likeForm.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.classList.toggle('active');
                        const countSpan = this.querySelector('.reaction-count');
                        countSpan.textContent = data.like_count;
                        
                        if (this.classList.contains('active')) {
                            this.querySelector('.reaction-icon').textContent = '‚ù§Ô∏è';
                            this.querySelector('.reaction-label').textContent = 'ƒê√£ th√≠ch';
                        } else {
                            this.querySelector('.reaction-icon').textContent = 'ü§ç';
                            this.querySelector('.reaction-label').textContent = 'Th√≠ch';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    }
    
    // Toggle reactions panel
    function toggleReactions() {
        reactionsPanel.classList.toggle('show');
    }
    
    // Close reactions panel when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.reaction-section')) {
            reactionsPanel.classList.remove('show');
        }
    });
    
    // Reaction buttons
    document.querySelectorAll('.reaction-option').forEach(btn => {
        btn.addEventListener('click', function() {
            const reaction = this.dataset.reaction;
            console.log(`Selected reaction: ${reaction}`);
            reactionsPanel.classList.remove('show');
            // Here you would send the reaction to server
        });
    });
    
    // Share post
    window.sharePost = function() {
        const shareData = {
            title: '{{ post.title }}',
            text: '{{ post.content|truncatewords:30 }}',
            url: window.location.href
        };
        
        if (navigator.share) {
            navigator.share(shareData)
                .then(() => console.log('B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c chia s·∫ª'))
                .catch(error => console.log('L·ªói chia s·∫ª:', error));
        } else {
            // Fallback: Copy to clipboard
            navigator.clipboard.writeText(window.location.href)
                .then(() => alert('üìã ƒê√£ sao ch√©p link b√†i vi·∫øt v√†o clipboard!'))
                .catch(err => console.error('L·ªói sao ch√©p:', err));
        }
    };
    
    // Toggle bookmark
    window.toggleBookmark = function() {
        const bookmarkBtn = document.querySelector('.bookmark-btn');
        bookmarkBtn.classList.toggle('active');
        
        if (bookmarkBtn.classList.contains('active')) {
            bookmarkBtn.querySelector('.action-icon').textContent = 'üîñ';
            bookmarkBtn.querySelector('.action-text').textContent = 'ƒê√£ l∆∞u';
            console.log('B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c l∆∞u');
        } else {
            bookmarkBtn.querySelector('.action-icon').textContent = 'üîñ';
            bookmarkBtn.querySelector('.action-text').textContent = 'L∆∞u';
            console.log('B√†i vi·∫øt ƒë√£ b·ªè l∆∞u');
        }
    };
    
    // Report post
    window.reportPost = function() {
        const reason = prompt('Vui l√≤ng nh·∫≠p l√Ω do b√°o c√°o b√†i vi·∫øt:');
        if (reason) {
            console.log('Report submitted:', reason);
            alert('C·∫£m ∆°n b·∫°n ƒë√£ b√°o c√°o. Ch√∫ng t√¥i s·∫Ω xem x√©t b√†i vi·∫øt n√†y.');
        }
    };
    
    // Scroll to comments
    window.scrollToComments = function() {
        document.getElementById('commentsSection').scrollIntoView({
            behavior: 'smooth'
        });
        if (commentInput) commentInput.focus();
    };
    
    // Toggle sort comments
    window.toggleSort = function() {
        const sortText = document.getElementById('sortText');
        const currentSort = sortText.textContent;
        const options = ['M·ªõi nh·∫•t', 'C≈© nh·∫•t', 'Nhi·ªÅu like nh·∫•t'];
        const currentIndex = options.indexOf(currentSort);
        const nextIndex = (currentIndex + 1) % options.length;
        sortText.textContent = options[nextIndex];
        console.log('Sorting by:', options[nextIndex]);
    };
    
    // Editor tools for comments
    toolButtons.forEach(button => {
        button.addEventListener('click', function() {
            if (!commentInput) return;
            
            const tag = this.dataset.tag;
            const start = commentInput.selectionStart;
            const end = commentInput.selectionEnd;
            const selectedText = commentInput.value.substring(start, end);
            let newText = '';
            
            switch(tag) {
                case 'bold':
                    newText = `**${selectedText || 'vƒÉn b·∫£n'}**`;
                    break;
                case 'italic':
                    newText = `*${selectedText || 'vƒÉn b·∫£n'}*`;
                    break;
                case 'code':
                    newText = selectedText ? `\`${selectedText}\`` : '`code`';
                    break;
                case 'link':
                    newText = `[${selectedText || 'vƒÉn b·∫£n'}](https://example.com)`;
                    break;
            }
            
            commentInput.setRangeText(newText, start, end, 'end');
            commentInput.focus();
        });
    });
    
    // Submit comment on Ctrl+Enter
    if (commentInput) {
        commentInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter' && commentForm) {
                e.preventDefault();
                commentForm.submit();
            }
        });
    }
    
    // Reply to comment
    window.replyToComment = function(commentId, username) {
        const replyForm = document.getElementById(`replyForm${commentId}`);
        const textarea = replyForm.querySelector('textarea');
        
        // Hide other reply forms
        document.querySelectorAll('.reply-form').forEach(form => {
            form.style.display = 'none';
        });
        
        // Show this reply form
        replyForm.style.display = 'block';
        textarea.placeholder = `Tr·∫£ l·ªùi ${username}...`;
        textarea.focus();
    };
    
    window.cancelReply = function(commentId) {
        const replyForm = document.getElementById(`replyForm${commentId}`);
        replyForm.style.display = 'none';
    };
    
    window.sendReply = function(commentId) {
        const replyForm = document.getElementById(`replyForm${commentId}`);
        const textarea = replyForm.querySelector('textarea');
        const content = textarea.value.trim();
        
        if (content) {
            console.log('Sending reply to comment', commentId, ':', content);
            // Here you would send the reply to server
            replyForm.style.display = 'none';
            textarea.value = '';
        } else {
            alert('Vui l√≤ng nh·∫≠p n·ªôi dung tr·∫£ l·ªùi!');
        }
    };
    
    // Load more comments
    window.loadMoreComments = function() {
        console.log('Loading more comments...');
        // Here you would fetch more comments via AJAX
    };
    
    // Delete post modal
    if (deletePostBtn) {
        deletePostBtn.addEventListener('click', function() {
            deleteModal.classList.add('show');
        });
    }
    
    window.closeModal = function() {
        deleteModal.classList.remove('show');
    };
    
    // Close modal when clicking outside
    deleteModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // Initialize
    console.log('Forum detail page loaded');
});
</script>
{% endblock %}